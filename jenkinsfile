pipeline {
    agent any

    environment {
        REMOTE_USER = "ec2-user"
        REMOTE_HOST = "3.110.121.35"
        CRED_ID     = "ansible-key"
    }

    stages {

        stage('Checkout Code') {
            steps {
                git url: 'git@github.com:dalvipiyush07/ansible-3-tier-project.git',
                    branch: 'main',            }
        }

        stage('Install Ansible on Jenkins Node') {
            steps {
                sh '''
                    if ! command -v ansible-playbook >/dev/null 2>&1; then
                      sudo apt update
                      sudo apt install -y ansible
                    fi
                '''
            }
        }

        stage('Prepare SSH Key') {
            steps {
                withCredentials([
                    sshUserPrivateKey(
                        credentialsId: 'ansible-key',
                        keyFileVariable: 'SSH_KEY'
                    )
                ]) {
                    sh '''
                        mkdir -p ~/.ssh
                        cp $SSH_KEY ~/.ssh/id_rsa
                        chmod 600 ~/.ssh/id_rsa
                    '''
                }
            }
        }

        stage('Generate Inventory & Deploy') {
            steps {
                withCredentials([
                    string(credentialsId: 'WEB_SERVER_IP', variable: '10.0.26.101'),
                    string(credentialsId: 'APP_SERVER_IP', variable: '10.0.24.77'),
                ]) {
                    sh '''
                        export SSH_KEY_PATH=~/.ssh/id_rsa
                        envsubst < ansible/inventory.ini > ansible/inventory.gen.ini
                        cd ansible
                        ansible-playbook -i inventory.gen.ini web.yml
                        ansible-playbook -i inventory.gen.ini app.yml
                    '''
                }
            }
        }
    }
}
